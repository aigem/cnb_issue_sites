#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('ğŸš€ å¼€å§‹æ„å»ºCNBé™æ€åšå®¢...\n');

// åŠ è½½ç¯å¢ƒå˜é‡
function loadEnvFile(filePath) {
  if (fs.existsSync(filePath)) {
    const envContent = fs.readFileSync(filePath, 'utf8');
    const lines = envContent.split('\n');

    lines.forEach(line => {
      line = line.trim();
      if (line && !line.startsWith('#')) {
        const [key, ...valueParts] = line.split('=');
        if (key && valueParts.length > 0) {
          const value = valueParts.join('=').trim();
          // ç§»é™¤å¼•å·
          const cleanValue = value.replace(/^["']|["']$/g, '');
          // åªåœ¨ç¯å¢ƒå˜é‡ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
          if (!process.env[key.trim()]) {
            process.env[key.trim()] = cleanValue;
          }
        }
      }
    });
    console.log(`âœ… å·²åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶: ${filePath}`);
  }
}

// è®¾ç½®ç‰¹å®šCI/éƒ¨ç½²ç¯å¢ƒå˜é‡ï¼ˆä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
function setupCIEnvironmentVariables() {
  // ä»CNB_REPO_SLUG_LOWERCASEè·å–REPOå€¼ (ç‰¹å®šCI/éƒ¨ç½²ç¯å¢ƒ)
  // è¿™å…è®¸åœ¨CIä¸­é€šè¿‡CNB_REPO_SLUG_LOWERCASEè®¾ç½®REPO
  if (process.env.CNB_REPO_SLUG_LOWERCASE && !process.env.REPO) {
    process.env.REPO = process.env.CNB_REPO_SLUG_LOWERCASE;
    console.log(`ğŸ”§ REPOè®¾ç½®ä¸ºCNB_REPO_SLUG_LOWERCASEçš„å€¼: ${process.env.REPO}`);
  }

  // ä»CNB_TOKENè·å–AUTH_TOKENå€¼ (ç‰¹å®šCI/éƒ¨ç½²ç¯å¢ƒ)
  // è¿™å…è®¸åœ¨CIä¸­é€šè¿‡CNB_TOKENè®¾ç½®AUTH_TOKEN
  if (process.env.CNB_TOKEN && !process.env.AUTH_TOKEN) {
    process.env.AUTH_TOKEN = process.env.CNB_TOKEN;
    console.log('ğŸ”§ AUTH_TOKENè®¾ç½®ä¸ºCNB_TOKENçš„å€¼');
  }
}

// 1. åŠ è½½ .env.local æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼Œä½†ä¸ä¼šè¦†ç›–å·²é€šè¿‡å…¶ä»–æ–¹å¼è®¾ç½®çš„ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
loadEnvFile('.env.local');

// 2. è®¾ç½®ç‰¹å®šCI/éƒ¨ç½²ç¯å¢ƒå˜é‡ (å¯èƒ½ä¼šè¦†ç›–.env.localä¸­çš„å€¼ï¼Œå¦‚æœCIå˜é‡å·²è®¾ç½®)
setupCIEnvironmentVariables();

console.log('ğŸ”§ åº”ç”¨ç¯å¢ƒå˜é‡æ‘˜è¦:');
console.log(`   BASE_URL: ${process.env.BASE_URL || 'æœªè®¾ç½® (å°†ä»lib/config.tsè·å–é»˜è®¤å€¼)'}`);
console.log(`   REPO: ${process.env.REPO || 'æœªè®¾ç½® (æ„å»ºå°†å¤±è´¥)'}`);
console.log(`   AUTH_TOKEN: ${process.env.AUTH_TOKEN ? '***å·²è®¾ç½®***' : 'æœªè®¾ç½® (æ„å»ºå°†å¤±è´¥)'}`);
if (process.env.CNB_REPO_SLUG_LOWERCASE) {
  console.log(`   (CI) CNB_REPO_SLUG_LOWERCASE: ${process.env.CNB_REPO_SLUG_LOWERCASE}`);
}
if (process.env.CNB_TOKEN) {
  console.log(`   (CI) CNB_TOKEN: ***å·²è®¾ç½®***`);
}
console.log('   å…¶ä»–NEXT_PUBLIC_*å˜é‡å°†ç”±lib/config.tså¤„ç† (é»˜è®¤å€¼, blog.config.json, æˆ–ç¯å¢ƒå˜é‡)\n');

// éªŒè¯æ„å»ºè¿‡ç¨‹å¿…éœ€çš„ç¯å¢ƒå˜é‡
// BASE_URLä¹Ÿç”±lib/config.tså¤„ç†å…¶é»˜è®¤å€¼ï¼Œä½†å¦‚æœAPIåœ¨æ„å»ºæ—¶å°±éœ€è¦ï¼Œåˆ™å¯èƒ½éœ€è¦æ£€æŸ¥
// å¯¹äºæ­¤é¡¹ç›®ï¼ŒAPIè°ƒç”¨ä¸»è¦åœ¨è¿è¡Œæ—¶æˆ–getStaticProps/getServerSidePropsï¼Œ
// ä½†next.config.jsä¸­çš„envä½¿å…¶åœ¨æ„å»ºæ—¶å¯ç”¨ã€‚
// lib/config.tsä¼šæä¾›é»˜è®¤å€¼ï¼Œæ‰€ä»¥è¿™é‡Œä¸å¼ºåˆ¶æ£€æŸ¥BASE_URLã€‚
const criticalEnvVars = ['REPO', 'AUTH_TOKEN'];
const missingVars = criticalEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
  console.error('âŒ ç¼ºå°‘æ„å»ºè¿‡ç¨‹å¿…éœ€çš„ç¯å¢ƒå˜é‡:');
  missingVars.forEach(varName => {
    console.error(`   - ${varName}`);
  });
  console.error('\nè¯·ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²è®¾ç½® (ä¾‹å¦‚, åœ¨.env.localæ–‡ä»¶æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­):');
  console.error('   - REPO (æˆ–è€…é€šè¿‡CNB_REPO_SLUG_LOWERCASEåœ¨CIä¸­è®¾ç½®)');
  console.error('   - AUTH_TOKEN (æˆ–è€…é€šè¿‡CNB_TOKENåœ¨CIä¸­è®¾ç½®)');
  console.error('\nCNBåšå®¢æ„å»ºå¤±è´¥ã€‚');
  process.exit(1);
}

// BASE_URLçš„æ£€æŸ¥è¢«ç§»é™¤ï¼Œå› ä¸ºlib/config.tsæœ‰é»˜è®¤å€¼ã€‚
// å¦‚æœç‰¹å®šæ„å»ºæ­¥éª¤ç»å¯¹éœ€è¦å®ƒï¼Œå¹¶ä¸”ä¸èƒ½ä¾èµ–lib/config.tsçš„é»˜è®¤å€¼ï¼Œ
// åˆ™åº”å°†å…¶æ·»åŠ å›criticalEnvVarsã€‚

console.log('âœ… æ„å»ºè¿‡ç¨‹å¿…éœ€çš„ç¯å¢ƒå˜é‡å·²è®¾ç½®ã€‚\n');

try {
  // æ¸…ç†ä¹‹å‰çš„æ„å»º
  console.log('ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶...');

  // è·¨å¹³å°åˆ é™¤ç›®å½•
  function removeDir(dirPath) {
    if (fs.existsSync(dirPath)) {
      try {
        fs.rmSync(dirPath, { recursive: true, force: true });
        console.log(`   âœ… å·²åˆ é™¤: ${dirPath}`);
      } catch (error) {
        console.log(`   âš ï¸  åˆ é™¤å¤±è´¥: ${dirPath} - ${error.message}`);
      }
    }
  }

  removeDir('out');
  removeDir('.next');

  // å®‰è£…ä¾èµ–
  console.log('ğŸ“¦ æ£€æŸ¥ä¾èµ–...');
  if (!fs.existsSync('node_modules')) {
    console.log('ğŸ“¦ å®‰è£…ä¾èµ–...');
    execSync('pnpm install --frozen-lockfile', { stdio: 'inherit' });
  }

  // æ„å»ºé¡¹ç›®
  console.log('ğŸ”¨ æ„å»ºNext.jsé¡¹ç›®...');
  execSync('pnpm build', { stdio: 'inherit' });

  // æ³¨æ„ï¼šNext.js 15 çš„ output: 'export' ä¼šè‡ªåŠ¨å¯¼å‡ºï¼Œä¸éœ€è¦å•ç‹¬çš„ export å‘½ä»¤
  console.log('âœ… é™æ€æ–‡ä»¶å·²è‡ªåŠ¨å¯¼å‡ºåˆ° out ç›®å½•');

  // ç”Ÿæˆé¢å¤–çš„é™æ€æ–‡ä»¶ (sitemap.xml and rss.xml are now generated by Next.js Route Handlers)
  console.log('ğŸ“„ å¤„ç†é¢å¤–çš„é™æ€æ–‡ä»¶...');

  // å¤åˆ¶robots.txtï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  // NEXT_PUBLIC_SITE_URL is used here. Ensure it's set for correct Sitemap URL in robots.txt.
  // It will default to 'https://blog.example.com' if not set, which might be incorrect for production.
  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://blog.example.com';
  if (siteUrl === 'https://blog.example.com' && process.env.NODE_ENV === 'production') {
    console.warn('âš ï¸  NEXT_PUBLIC_SITE_URL is not set. The Sitemap URL in robots.txt might be incorrect.');
    console.warn('   Please set NEXT_PUBLIC_SITE_URL in your environment or blog.config.json (site.url).');
  }

  if (!fs.existsSync('out/robots.txt')) {
    const robotsTxt = `User-agent: *
Allow: /

Disallow: /api/
Disallow: /_next/
Disallow: /admin/

Sitemap: ${siteUrl}/sitemap.xml

Crawl-delay: 1`;
    fs.writeFileSync('out/robots.txt', robotsTxt);
  }

  // æ£€æŸ¥æ„å»ºç»“æœ
  console.log('âœ… æ£€æŸ¥æ„å»ºç»“æœ...');
  const outDir = 'out';
  const stats = fs.statSync(outDir);

  if (stats.isDirectory()) {
    const files = fs.readdirSync(outDir);
    console.log(`ğŸ“Š æ„å»ºå®Œæˆï¼ç”Ÿæˆäº† ${files.length} ä¸ªæ–‡ä»¶/ç›®å½•`);

    // æ˜¾ç¤ºä¸»è¦æ–‡ä»¶
    const mainFiles = files.filter(file =>
      file.endsWith('.html') ||
      file.endsWith('.xml') ||
      file.endsWith('.txt') ||
      file === '_next'
    );

    console.log('ğŸ“ ä¸»è¦æ–‡ä»¶:');
    mainFiles.forEach(file => {
      console.log(`   - ${file}`);
    });
  }

  console.log('\nğŸ‰ æ„å»ºæˆåŠŸå®Œæˆï¼');
  console.log(`ğŸ“‚ é™æ€æ–‡ä»¶ä½äº: ${path.resolve(outDir)}`);
  console.log('ğŸš€ ç°åœ¨å¯ä»¥éƒ¨ç½²åˆ°ä»»ä½•é™æ€æ‰˜ç®¡æœåŠ¡äº†ï¼');

} catch (error) {
  console.error('\nâŒ æ„å»ºå¤±è´¥:', error.message);
  process.exit(1);
}
